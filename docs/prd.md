# Relaym PRD (プロダクト要求仕様書)

## 概要

Relaymはみんなで一つのSpotifyのプレイリストを共有して、一つの端末で再生しながらも、自分の端末で好きな曲を追加することができる感じのWebサービス。

## どんな問題を解決するプロダクトか？

ドライブ中に曲を流すことがあるが、複数人の場合、みんなが口々に流したい曲を言い合って、スマホを操作している人が大変、、、

流したい曲を自分のスマホから検索・追加できるようにしたら色んな曲を簡単にかけることができる。

## 誰のために問題を解決するのか？

- 友人同士でドライブに行く大学生

## ユースケース

### Relaymを開いてから曲の再生まで

1. 曲を再生する人がRelaymにログインする
2. 新規のセッションを作成する
3. 招待リンクをLINEで友人らに伝える
4. 友人らがRelaymにログインする
5. 各々が検索画面から好きな曲を追加する
6. 曲を再生する人がデバイスを選択して曲を再生し始める

### 招待リンクを受け取ってからセッションに参加するまで

1. 招待リンクをクリックする
2. ログインしてくださいページに遷移する
3. Spotifyの認証を行う
4. 該当セッションのページにリダイレクトされる


## ゴール

上のコンセプトを実現する最低限の機能を良いUXで提供して、**リリースすること**を目標にする。

機能追加はできるだけ絞って、素早くリリースできるように心がける。

## プロトタイプ

あくまでプロトタイプであり、この通り実装するわけではないことに注意。

- Adobe XD : https://xd.adobe.com/spec/95bf8657-4e79-44fb-7351-c7a4067a2425-e38e/
- ハッカソンで作った作り直す前の実装 : [https://develop--relaym.netlify.com/](https://develop--relaym.netlify.com/)

### カラーパレット

https://coolors.co/dc4a5e-14213d-707070-eeeeee-ffffff


## 各種リンク
- クライアントリポジトリ : https://github.com/camphor-/here-songs-client
- サーバリポジトリ : https://github.com/camphor-/relaym-server 
- API仕様書 : https://github.com/camphor-/relaym-server/blob/master/docs/api.md

---  

# 機能要求

## ユーザ (user)

- [ ] 全てのセッションに参加するユーザはSpotifyのアカウントを持っている必要がある
    - Spotifyの検索APIをユーザのアクセストークンを使いたいので
    - UX的に要検証
- [ ] 一度ログインすると、クッキーを消す or サーバ側でクッキー情報を削除した場合のみログアウトされる

## セッション (session)

セッションは一つの集まり (ex. 一緒にドライブに行く友人ら)を表す。ユーザが行う曲に関連する操作はすべてセッションを通じて行われる。 

### セッションの作成

- [ ] セッションはSpotifyのプレミアム会員のユーザのみ作成できる。 
    - プレミアム会員しか好きな曲を好きなタイミングで再生できない
- [ ] セッション作成時に好きな名前をつけることができる。
    - 現状は変更不可  (変更したいユースケースが思いつかない)
- [ ] セッション作成時にセッションに参加するための招待リンクを作成できる
- セッションの作成者は作成者(creater)と呼ばれる。

<img src="https://i.imgur.com/vOIiyEs.png" width=300px>

### セッションのメイン画面

- [ ] 現在再生中の曲 or 再生が一時停止されているが再生ボタンを押すと流れ始める曲がトップに表示されている
- [ ] 追加された曲がキュー(queue)に追加されていて、表示されている
- [ ] 再生が終わった曲は上にスクロールすると表示される
- [ ] 右下のボタンを押すと検索画面に推移できる
- [ ] 左下のボタンを押すと再生デバイスの選択ポップアップが出現する
- [ ] 中央下のボタンを押すことで再生(PLAY)・一時停止(PAUSE)を行うことができる
    - セッション作成者のみ操作可能
        - 再生されるのがセッション作成者の端末なので
    - デバイスが選択されておらず失敗した場合はスナックバーで誘導の文章がでる
- [ ] シークバーがリアルタイムで更新される
    - クライアント側でタイマーを持つ
- [ ] 次の曲に移るとトップに表示されている情報が切り替わる

<img src="https://i.imgur.com/Z0BmDD2.png" width=300px>

<img src="https://i.imgur.com/9uf3UVE.pngg" width=300px>



### 曲の追加

- [ ] 検索画面で検索クエリを用いて曲を検索することができる
    - 20件の検索結果が表示される
    - リコメンドではなく自分で具体的な検索クエリを打つので、検索順位が低い曲を見ることは少ないので、Lazy Loadは行わない。
- [ ] +ボタンを押して曲をキューに追加するとスナックバーが表示される
- [ ] 一度に複数の曲を追加できる
    - あるアーティストの曲を何曲も流したいという状況が想定されるため
- [ ] 一つのセッションに同じ曲を複数回登録することができる
- [ ] 追加できる曲数に制限はない
- [ ] キューの曲順の変更はできない
- [ ] キューにした曲の削除はできない (いまのところ)

<img src="https://i.imgur.com/vAdOzQe.png" width=300px>


<img src="https://i.imgur.com/0tMzApR.png" width=300px>

### セッションの状態

|名前|説明|
|-|-|
| PLAY | 曲が再生されている状態 |
| PAUSE | 曲を再生していたが途中で一時停止ボタンを押した状態|
| STOP | 曲の再生を一度も開始していない or すべての曲の再生が終了した状態 | 

#### 状態遷移パターン

- STOP → PLAY
- PLAY → STOP
- PLAY → PAUSE
- PAUSE → PLAY


### 曲の再生

- [ ] 流している曲が終了して次の曲がキューに存在する場合、自動で次の曲がスタートする
- [ ] 流している曲が終了して次の曲がキューに存在しない場合、再生が終了(STOP)する
- [ ] 再生が終了(STOP)で検索画面で曲を追加した場合、自動で曲の再生が始まる
    - デバイスがアクティブでない場合などで再生に失敗した場合はエラーを出さず、ユーザが再生ボタンを押すのを待つ


### Spotifyとの同期チェック

Spotify本体側のアプリを操作されると、Relaymの情報とSpotify側の情報に齟齬が生じてしまう。  
Relaym側を完全に正として扱うのは技術的に極めて難しいので、Spotify側で操作されたら同期をとるのは諦める。


- [ ] 同期のチェックは現在再生している曲とされる曲の終了時間 + 5秒後に行う。
	- 次の曲が存在する場合、Spotify側の「次に再生する曲」に曲が詰まれていて、それがこのタイミングで再生されているはず。
	- ここで違う曲が流れていたらSpotify側で操作されたとみなす。
	- [ ] 想定される曲が流れていた場合、現在の再生時間から次のチェック時間を計算してタイマーをセットする 。

### Spotifyとの曲の同期に失敗したとき

- [ ] 想定外の操作があったら、現在のRelaym側の再生状況を保存して一時停止する(PAUSE)
- [ ] 想定外の操作が起こったことををモーダルでユーザに表示される
- [ ] モーダルの再開ボタンを押すことで、保存された再生状況を復旧し、その状態から再開される


---

## 競合

### Spotify コラボプレイリスト

https://support.spotify.com/jp/using_spotify/playlists/create-playlists-with-your-friends/

> 友達を誘ってオリジナルプレイリストを一緒に作ろう！プレイリストをコラボに設定すると、だれでも曲の追加や削除、再生順の変更などを自由にできるようになります。
> 

- 公式で似たような機能を出している()
- これに勝てる優位性として、Spotifyのアカウントがなくても曲の追加をできるようにしたい (@p1ass の個人的な感想)
    - 現状の仕様ではできない


